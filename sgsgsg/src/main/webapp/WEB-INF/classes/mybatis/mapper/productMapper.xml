<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sgsg.dra.mapper.ProductMapper">

	<!-- 카테고리 이름/아이콘 목록 -->
	<select id="selectCategoryList"
		resultType="com.sgsg.dra.domain.Product">
		SELECT CATEGORYNUM, CATEGORYNAME, CATEGORYIMAGE
		FROM
		PRODUCT_CATEGORY
		WHERE USE = 1 AND DISPLAYNO &lt;= 8
		ORDER BY DISPLAYNO
	</select>

	<!-- 일반 상품 개수 조회 -->
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT
		NVL(COUNT(*),0)
		FROM product
		WHERE classify = 1
		AND productShow =1
		AND
		categoryNum=#{categoryNum}
	</select>

	<select id="listProduct"
		resultType="com.sgsg.dra.domain.Product">
		SELECT productNum, categoryNum, productName, price, savedMoney,
		discountRate, optionCount, delivery, thumbnail
		FROM PRODUCT
		WHERE productShow = 1
		ORDER BY productNum DESC
	</select>

	<!-- 상품 상세정보 가져오기 -->
	<!--상품번호,카테고리번호,분류(일반,기획),상품노출여부,상품이름,가격,적립금,옵션개수,할인율,배송비,썸네일이미지,내용,등록날짜,총 재고,리뷰점수,  -->
	<!-- 리뷰개수,질문개수,시작날짜,종료날짜,특별노출여부,판매개수 -->
	<select id="findById" parameterType="Long"
		resultType="com.sgsg.dra.domain.Product">
		SELECT p.productNum, p.categoryNum, p.classify,
		p.productShow,
		c.categoryName,
		p.productName, p.price, p.savedMoney,
		p.optionCount, p.discountRate, p.delivery,
		p.thumbnail, p.content,
		p.reg_date, NVL(ps.totalStock, 0)
		totalStock,NVL(t.score, 0) score,
		NVL(t.reviewCount, 0) reviewCount, NVL(pi.questionCount, 0)
		questionCount,
		TO_CHAR(s.startDate, 'YYYY-MM-DD HH24:MI') startDate,
		TO_CHAR(s.endDate, 'YYYY-MM-DD HH24:MI') endDate,
		NVL(s.showSpecial,
		-1) showSpecial,
		NVL(pc.saleCount, 0) saleCount
		FROM product p
		JOIN
		PRODUCT_CATEGORY c ON p.categoryNum = c.categoryNum
		LEFT OUTER JOIN (
		SELECT productNum, NVL(SUM(totalStock), 0) totalStock
		FROM productStock
		GROUP BY productNum
		) ps ON p.productNum = ps.productNum
		LEFT OUTER JOIN
		specialsDetail d ON p.productNum = d.productNum
		LEFT OUTER JOIN
		specials s ON d.specialNum = s.specialNum
		LEFT OUTER JOIN (
		SELECT
		ps.productNum, ROUND(AVG(pr.score), 1) score, COUNT(*) reviewCount
		FROM ORDERDETAIL od
		JOIN PRODUCT_REVIEW pr ON od.ORDERDETAILNUM =
		pr.ORDERDETAILNUM
		JOIN productStock ps ON od.STOCKNUM = ps.STOCKNUM
		WHERE pr.showReview = 1 AND pr.locked = 0
		GROUP BY ps.productNum
		) t ON
		p.productNum = t.productNum
		LEFT OUTER JOIN (
		SELECT productNum,
		COUNT(*) questionCount
		FROM PRODUCT_INQUIRY
		WHERE showQuestion = 1 AND
		locked = 0
		GROUP BY productNum
		) pi ON p.productNum = pi.productNum
		LEFT
		OUTER JOIN (
		SELECT ps.productNum, COUNT(*) saleCount
		FROM ORDERDETAIL
		od
		JOIN productStock ps ON od.STOCKNUM = ps.STOCKNUM
		GROUP BY
		ps.productNum
		) pc ON p.productNum = pc.productNum
		WHERE p.productShow =
		1 AND p.productNum = #{productNum}
	</select>

	<!-- 상품 이미지 조회 -->
	<select id="listProductFile" parameterType="Long"
		resultType="com.sgsg.dra.domain.Product">
		SELECT fileNum,productNum,img_name
		FROM PRODUCT_IMAGE
		WHERE productNum = #{productNum}
	</select>


</mapper>